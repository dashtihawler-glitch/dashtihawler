<!DOCTYPE html>
<html lang="ckb" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>گرێبەستی فرۆشتن - نوسینگەی دەشتی هەولێر</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;700&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@300;400;500;700&family=Noto+Sans+Arabic:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <header class="main-header">
        <button id="sidebar-toggle" class="toggle-btn" aria-label="کردنەوەی لیست">
            <i class='bx bx-menu'></i>
        </button>
        <div class="header-brand">
            <img src="../assets/icon.png" alt="لۆگۆ" class="header-logo">
            <h3>نوسینگەی دەشتی هەولێر</h3>
        </div>
        <div class="user-info" id="user-display">
            <span id="user-email">بارکردن...</span>
            <i class='bx bxs-user-circle'></i>
        </div>
    </header>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="../dashboard.html"><i class='bx bxs-dashboard'></i><span>داشبۆردی سەرەکی</span></a></li>
                    <li class="active"><a href="index.html"><i class='bx bx-file'></i><span>گرێبەستەکان</span></a></li>
                    <li><a href="../archive/archive.html"><i class='bx bx-archive'></i><span>ئەرشیفی گرێبەستەکان</span></a></li>
                    <li><a href="#"><i class='bx bx-shield-quarter'></i><span>بەشی دڵنیایی (تەئمینات)</span></a></li>
                    <li><a href="../krechi\index.html"><i class='bx bx-group'></i><span>کرێچییەکان</span></a></li>
                    <li><a href="#"><i class='bx bx-cog'></i><span>ڕێکخستنی وێب</span></a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a href="#" id="logout-btn" class="logout-btn">چوونەدەرەوە</a>
            </div>
        </aside>
        <main class="main-content" id="main-content">
            <div class="content-area">
                <div class="page-header-flex">
                    <h2>گرێبەستی فرۆشتن</h2>
                    <a href="index.html" class="btn-login btn-back">
                        <i class='bx bx-arrow-back'></i> گەڕانەوە
                    </a>
                </div>
                
                <div class="form-container sales-form-container">
                    <form id="salesForm">
                        <div class="form-grid">
                            <!-- Employee Email (Auto-filled) -->
                            <div class="input-group full-width">
                                <label for="employeeEmail">ئەمڕۆ کێ گرێبەستەکە دەکات ؟</label>
                                <input type="email" id="employeeEmail" name="farmanbar" readonly class="input-readonly" placeholder="ئیمەیڵی کارمەند...">
                            </div>

                            <!-- Seller/Customer Section -->
                            <div class="form-section">
                                <h4>زانیاری فرۆشیار</h4>
                                <div class="input-group">
                                    <label for="sellerName">ناوی سیانی فرۆشیار</label>
                                    <input type="text" id="sellerName" name="Third name of the seller" required placeholder="ناوی فرۆشیار بنووسە">
                                </div>
                                <div class="input-group">
                                    <label for="sellerID">ژمارەی ناسنامەی فرۆشیار</label>
                                    <input type="text" id="sellerID" name="Seller ID number" required placeholder="ژمارەی ناسنامە">
                                </div>
                                <div class="input-group">
                                    <label for="sellerMobile">ژمارەی مۆبایلی فرۆشیار</label>
                                    <input type="tel" id="sellerMobile" name="Seller mobile number" required placeholder="0750xxxxxxx">
                                </div>
                            </div>
                            <div class="form-section">
                                <h4>زانیاری کڕیار</h4>
                                <div class="input-group">
                                    <label for="customerName">ناوی سیانی کڕیار</label>
                                    <input type="text" id="customerName" name="Third name of the customer" required placeholder="ناوی کڕیار بنووسە">
                                </div>
                                <div class="input-group">
                                    <label for="customerID">ژمارەی ناسنامەی کڕیار</label>
                                    <input type="text" id="customerID" name="Customer ID number" required placeholder="ژمارەی ناسنامە">
                                </div>
                                <div class="input-group">
                                    <label for="customerMobile">ژمارەی مۆبایلی کڕیار</label>
                                    <input type="tel" id="customerMobile" name="Customer mobile number" required placeholder="0750xxxxxxx">
                                </div>
                            </div>

                            <!-- Property Info -->
                            <div class="form-row full-width form-row-3-cols">
                                <div class="input-group">
                                    <label for="propertyType">جۆری موڵک</label>
                                    <select name="Property type" id="propertyType" required>
                                        <option value="" disabled selected>هەڵبژێرە...</option>
                                        <option value="خانوو">خانوو</option>
                                        <option value="شووقە">شووقە</option>
                                        <option value="دوکان">دوکان</option>
                                        <option value="زەوی">زەوی</option>
                                        <option value="باڵەخانە">باڵەخانە</option>
                                        <option value="زەوی کشتوکاڵی">زەوی کشتوکاڵی</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label for="propertyNumber">ژمارەی موڵک</label>
                                    <input type="text" id="propertyNumber" name="Property number" required placeholder="ژمارەی موڵک">
                                </div>
                                <div class="input-group">
                                    <label for="areaSelect">ڕووبەر</label>
                                    <select name="Area" id="areaSelect" required>
                                        <option value="" disabled selected>ڕووبەر هەڵبژێرە...</option>
                                        <option value="100">100م²</option>
                                        <option value="125">125م²</option>
                                        <option value="150">150م²</option>
                                        <option value="200">200م²</option>
                                        <option value="250">250م²</option>  
                                        <option value="300">300م²</option>
                                        <option value="400">400م²</option>
                                        <option value="500">500م²</option>
                                        <option value="600">600م²</option>
                                        <option value="other">ڕووبەرێکی تر (خۆت بینووسە)</option>
                                    </select>
                                    <input type="text" name="other_area" id="otherAreaInput" class="other-neighborhood-input hidden" placeholder="ڕووبەری تر بنووسە">
                                </div>
                            </div>
                             <div class="form-row full-width form-row-2-cols">
                                <div class="input-group">
                                    <label for="neighborhoodSelect">گەڕەک</label>
                                    <select name="Neighborhood" id="neighborhoodSelect" required>
                                        <option value="" disabled selected>گەڕەک هەڵبژێرە...</option>
                                        <option value="فەرمانبەران">فەرمانبەران</option>
                                        <option value="فەرمانبەران ئامرلیوا">فەرمانبەران ئامرلیوا</option>
                                        <option value="گەلاوێژ">گەلاوێژ</option>
                                        <option value="باداوە">باداوە</option>
                                        <option value="دارەتوو">دارەتوو</option>
                                        <option value="ژین">ژین</option>
                                        <option value="ژیان">ژیان</option>
                                        <option value="بنەسڵاوە">بنەسڵاوە</option>
                                        <option value="ئاوێنەی شار">ئاوێنەی شار</option>
                                        <option value="زەیتوونە">زەیتوونە</option>
                                        <option value="هیران ستی ئاڵا ستی">هیران ستی ئاڵا ستی</option>
                                        <option value="ڕۆشنبیری">ڕۆشنبیری</option>
                                        <option value="5ی حەسارۆك">5ی حەسارۆك</option>
                                        <option value="8ی حەسارۆك">8ی حەسارۆك</option>
                                        <option value="other">گەڕەکێکی تر (خۆت بینووسە)</option>
                                    </select>
                                    <input type="text" name="other_neighborhood" id="otherNeighborhoodInput" class="other-neighborhood-input hidden" placeholder="ناوی گەڕەکی تر بنووسە">
                                </div>
                            </div>

                            <!-- Financial Info -->
                            <div class="form-row full-width form-row-2-cols">
                                <div class="input-group">
                                    <label for="currencyType">جۆری دراو</label>
                                    <select name="currencyType" id="currencyType" required>
                                        <option value="دۆلاری ئەمریکی">دۆلاری ئەمریکی ($)</option>
                                    <option value="دیناری عێڕاقی">دیناری عێڕاقی (IQD)</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label for="salePrice">نرخی فرۆشتن (بە ژمارە)</label>
                                    <input type="text" inputmode="numeric" id="salePrice" name="Sale price in number" required placeholder="نرخی گشتی">
                                    <div id="salePriceWords" class="amount-words"></div>
                                </div>
                            </div>
                            <div class="form-row full-width form-row-2-cols">
                                <div class="input-group">
                                    <label for="depositAmount">بڕی پێشەکی (بە ژمارە)</label>
                                    <input type="text" inputmode="numeric" id="depositAmount" name="Amount of deposit in number" required placeholder="بڕی پێشەکی">
                                    <div id="depositAmountWords" class="amount-words"></div>
                                </div>
                                <div class="input-group">
                                    <label for="remainingAmount">بڕی پارەی ماوە (بە ژمارە)</label>
                                    <input type="text" inputmode="numeric" id="remainingAmount" name="The amount of money remaining in number" required placeholder="بڕی ماوە">
                                    <div id="remainingAmountWords" class="amount-words"></div>
                                </div>
                            </div>
                             <div class="form-row full-width form-row-2-cols">
                                <div class="input-group">
                                    <label for="penaltyAmount">سزای پەشیمانبوونەوە (بە ژمارە)</label>
                                    <input type="text" inputmode="numeric" id="penaltyAmount" name="penalty for repentance in number" required placeholder="بڕی سزا">
                                    <div id="penaltyAmountWords" class="amount-words"></div>
                                </div>
                            </div>

                            <!-- Lawyer & Witnesses -->
                            <div class="form-row full-width form-row-2-cols">
                                <div class="input-group">
                                    <label for="lawyerName">ناوی پارێزەر</label>
                                    <input type="text" id="lawyerName" name="Name of lawyer" required placeholder="ناوی پارێزەر بنووسە">
                                </div>
                                <div class="input-group">
                                    <label for="lawyerMobile">ژمارەی مۆبایلی پارێزەر</label>
                                    <input type="tel" id="lawyerMobile" name="Lawyer mobile number" required placeholder="0750xxxxxxx">
                                </div>
                            </div>
                            <div class="form-row full-width form-row-2-cols">
                                <div class="input-group">
                                    <label for="witness1">شایەدی یەکەم</label>
                                    <input type="text" id="witness1" name="The first witness" required placeholder="ناوی شایەدی یەکەم">
                                </div>
                                <div class="input-group">
                                    <label for="witness2">شایەدی دووەم</label>
                                    <input type="text" id="witness2" name="The second witness" required placeholder="ناوی شایەدی دووەم">
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn-login form-submit-btn">
                            <i class='bx bx-send'></i> تۆمارکردنی گرێبەست
                        </button>
                        <p id="msg" class="status-message"></p>
                    </form>
                </div>
            </div>
        </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module" src="../dashboard.js"></script>
    <script>
        const form = document.getElementById('salesForm');
        const statusMessage = document.getElementById('msg');
        // تێبینی: لێرەدا دەبێت لینکی سکریپتی گوگڵ شیتەکەت دابنێیت
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxUV5qdwxf36Sa99kwKBOl6TRDWZhCKI2tfi38_QqN4idG8-Dw1VLHy4q8CLDimxyVV/exec';

        // کارکردنی درۆپداونی گەڕەک
        const neighborhoodSelect = document.getElementById('neighborhoodSelect');
        const otherNeighborhoodInput = document.getElementById('otherNeighborhoodInput');

        neighborhoodSelect.addEventListener('change', function() {
            if (this.value === 'other') {
                otherNeighborhoodInput.classList.remove('hidden');
                otherNeighborhoodInput.setAttribute('required', 'required');
            } else {
                otherNeighborhoodInput.classList.add('hidden');
                otherNeighborhoodInput.removeAttribute('required');
                otherNeighborhoodInput.value = '';
            }
        });

        // کارکردنی درۆپداونی ڕووبەر
        const areaSelect = document.getElementById('areaSelect');
        const otherAreaInput = document.getElementById('otherAreaInput');

        areaSelect.addEventListener('change', function() {
            if (this.value === 'other') {
                otherAreaInput.classList.remove('hidden');
                otherAreaInput.setAttribute('required', 'required');
            } else {
                otherAreaInput.classList.add('hidden');
                otherAreaInput.removeAttribute('required');
                otherAreaInput.value = '';
            }
        });

        // گۆڕینی ژمارە بۆ نووسین و دانانی فاریزە
        const currencySelect = document.getElementById('currencyType');
        const inputsToFormat = [
            { input: document.getElementById('salePrice'), words: document.getElementById('salePriceWords') },
            { input: document.getElementById('depositAmount'), words: document.getElementById('depositAmountWords') },
            { input: document.getElementById('remainingAmount'), words: document.getElementById('remainingAmountWords') },
            { input: document.getElementById('penaltyAmount'), words: document.getElementById('penaltyAmountWords') }
        ];

        function numToKurdish(n) {
            if (n == 0) return "سفر";
            if (!n) return "";
            
            const ones = ["", "یەك", "دوو", "سێ", "چوار", "پێنج", "شەش", "حەوت", "هەشت", "نۆ"];
            const teens = ["دە", "یازدە", "دوازدە", "سێزدە", "چواردە", "پانزدە", "شازدە", "حەڤدە", "هەژدە", "نۆزدە"];
            const tens = ["", "", "بیست", "سی", "چل", "پەنجا", "شەست", "حەفتا", "هەشتا", "نەوەد"];
            const hundreds = ["", "سەد", "دوو سەد", "سێ سەد", "چوار سەد", "پێنج سەد", "شەش سەد", "حەوت سەد", "هەشت سەد", "نۆ سەد"];

            function convert(num) {
                if (num === 0) return "";
                if (num < 10) return ones[num];
                if (num < 20) return teens[num - 10];
                if (num < 100) return tens[Math.floor(num / 10)] + (num % 10 ? " و " + ones[num % 10] : "");
                if (num < 1000) return hundreds[Math.floor(num / 100)] + (num % 100 ? " و " + convert(num % 100) : "");
                if (num < 1000000) {
                    return (Math.floor(num / 1000) === 1 ? "هەزار" : convert(Math.floor(num / 1000)) + " هەزار") + (num % 1000 ? " و " + convert(num % 1000) : "");
                }
                if (num < 1000000000) {
                    return convert(Math.floor(num / 1000000)) + " ملیۆن" + (num % 1000000 ? " و " + convert(num % 1000000) : "");
                }
                return convert(Math.floor(num / 1000000000)) + " ملیار" + (num % 1000000000 ? " و " + convert(num % 1000000000) : "");
            }

            return convert(n);
        }

        function updateWords(input, display) {
            const rawValue = input.value.replace(/,/g, '');
            const val = parseInt(rawValue, 10);
            if (!isNaN(val) && rawValue.length > 0) {
                let text = numToKurdish(val);
                const currency = currencySelect.value;
                 if (currency === "دۆلاری ئەمریکی") {
                    text += " دۆلار";
                } else if (currency === "دیناری عێڕاقی") {
                    text += " دینار";
                }
                display.textContent = text;
            } else {
                display.textContent = "";
            }
        }

        function formatAndDisplay(input, wordsDisplay) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value.trim() === '') {
                input.value = '';
                wordsDisplay.textContent = '';
                return;
            }
            input.value = Number(value).toLocaleString('en-US');
            updateWords(input, wordsDisplay);
        }

        // Event Listeners
        inputsToFormat.forEach(item => {
            item.input.addEventListener('input', () => formatAndDisplay(item.input, item.words));
        });

        currencySelect.addEventListener('change', () => {
            inputsToFormat.forEach(item => {
                updateWords(item.input, item.words);
            });
        });

        // هەژمارکردنی پارەی ماوە بە شێوەی ئۆتۆماتیکی
        const salePriceInput = document.getElementById('salePrice');
        const depositAmountInput = document.getElementById('depositAmount');
        const remainingAmountInput = document.getElementById('remainingAmount');
        const remainingAmountWords = document.getElementById('remainingAmountWords');

        function calculateRemaining() {
            const salePrice = parseFloat(salePriceInput.value.replace(/,/g, '')) || 0;
            const deposit = parseFloat(depositAmountInput.value.replace(/,/g, '')) || 0;
            const remaining = Math.max(0, salePrice - deposit);
            remainingAmountInput.value = remaining;
            formatAndDisplay(remainingAmountInput, remainingAmountWords);
        }

        salePriceInput.addEventListener('input', calculateRemaining);
        depositAmountInput.addEventListener('input', calculateRemaining);

        form.addEventListener('submit', e => {
            e.preventDefault();
            statusMessage.textContent = 'جارێک چاوەڕێ بکە...';
            statusMessage.style.color = 'blue';
            
            const formData = new FormData(form);

            // لابردنی فاریزەکان لەناو FormData ڕاستەوخۆ
            // ئەمە باشترین ڕێگایە بۆ ئەوەی دڵنیابین ژمارەکان بەبێ فاریزە دەچن
            const numericFields = [
                'Sale price in number', 
                'Amount of deposit in number', 
                'The amount of money remaining in number', 
                'penalty for repentance in number'
            ];

            numericFields.forEach(fieldName => {
                const val = formData.get(fieldName);
                if (val) {
                    formData.set(fieldName, val.toString().replace(/,/g, ''));
                }
            });

            if (formData.get('Area') === 'other') {
                formData.set('Area', formData.get('other_area'));
            }
            if (formData.get('Neighborhood') === 'other') {
                formData.set('Neighborhood', formData.get('other_neighborhood'));
            }
            formData.delete('other_area');
            formData.delete('other_neighborhood');
            
            fetch(scriptURL, { method: 'POST', body: formData})
                .then(response => {
                    statusMessage.textContent = 'بە سەرکەوتوویی تۆمارکرا!';
                    statusMessage.style.color = 'green';
                    form.reset();
                    setTimeout(() => {
                        const userEmailDisplay = document.getElementById('user-email');
                        const employeeEmailInput = document.getElementById('employeeEmail');
                        if(userEmailDisplay && employeeEmailInput) {
                            employeeEmailInput.value = userEmailDisplay.textContent;
                        }
                    }, 100);
                })
                .catch(error => {
                    statusMessage.textContent = 'هەڵەیەک ڕوویدا! تکایە دووبارە هەوڵبدەرەوە.';
                    statusMessage.style.color = 'red';
                    console.error('Error!', error.message);
                });
        });
    </script>
</body>
</html>